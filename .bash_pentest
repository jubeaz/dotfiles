alias cme="crackmapexec"
alias a="arsenal"
alias ssh-keygenz="ssh-keygen -t ed25519 -f"

alias dirsearch="/usr/bin/dirsearch --config ~/.config/dirsearch/default.conf"
alias msfconsole="msfconsole -r ~/.msf4/msfconsole.rc"
alias nc="rlwrap nc"

alias gdb="gdb -q -ex init-pwndbg"
alias gdb-pwn="gdb -q -ex init-pwndbg"
alias gdb-gef="gdb -q -ex init-gef"
alias aslr-on="echo 2 | sudo tee /proc/sys/kernel/randomize_va_space"
alias aslr-off="echo 0 | sudo tee /proc/sys/kernel/randomize_va_space"
alias aslr-status="cat /proc/sys/kernel/randomize_va_space"

##
# pentesting commands
alias get-linpeas="curl -sLO https://github.com/carlospolop/PEASS-ng/releases/latest/download/linpeas.sh"
alias get-winpeas="curl -sLO https://github.com/carlospolop/PEASS-ng/releases/latest/download/winPEAS.bat"
# curl -s https://api.github.com/repos/carlospolop/PEASS-ng/releases/latest | grep browser_download_url | cut -d '"' -f 4

function masscanz() {
    sudo masscan -p1-65535,U:1-65535 $1 --rate=1000 -e tun0 --wait 5 > masscan.txt
}

alias gobusterz="gobuster dir -w /usr/share/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-medium.txt -u"

function ffuf-vhost(){
    if [[ $# -lt 1 ]] ; then
        echo 'invalid call: $0 url [wordlist [other_args]]'
        return
    fi
    argc=3
    if [[ $# -lt 2 ]] ; then
       argc=2 
    fi

    wl=${2:-/usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt}
    echo ffuf -H "Host: FUZZ.$1" -u $1 -w $wl ${@: $argc}
}

function nmapz() {
    PORTS=$(sudo nmap --min-rate=1000 -T4 -p- "$1" | grep '^[0-9]' | cut -d'/' -f 1 | tr '\n' ',' | sed s/',$'//) ;
    echo "ports found: $PORTS";
    USER=$(whoami)
    sudo nmap -sVC -p$PORTS -oX nmap.xml "$1";
    sudo chown $USER nmap.xml
}

function __get_github_release(){
    repo=$1
    filter=$2
    files=$(curl -s https://api.github.com/repos/$repo/releases/latest | grep browser_download_url | cut -d '"' -f 4 | grep -E "$filter")
    #echo $files
    echo $files | xargs wget --quiet  --no-check-certificate

}

function weaponize_windows(){
    # nc
    wget --quiet https://github.com/int0x33/nc.exe/raw/master/nc64.exe
    wget --quiet https://github.com/int0x33/nc.exe/raw/master/nc.exe
    # Sysinternals Suite
    wget --quiet https://download.sysinternals.com/files/SysinternalsSuite.zip
    # chisel
    __get_github_release jpillora/chisel 'windows_(386|amd64)'
    # LaZagne
    __get_github_release AlessandroZ/LaZagne 'exe'
    # winPEAS
    __get_github_release carlospolop/PEASS-ng "/winPEAS"
    # mimikatz
    __get_github_release gentilkiwi/mimikatz zip
    # PowerUpSQL
    exts=("psd1" "ps1" "psm1")
    for ext in ${exts[@]} ; do 
        wget --quiet https://raw.githubusercontent.com/NetSPI/PowerUpSQL/master/PowerUpSQL.$ext 2> /dev/null
        wget --quiet https://raw.githubusercontent.com/n0tspam/SinglePowerSpray/main/SinglePowerSpray.$ext 2> /dev/null
    done
    # Sharpview 
    wget --quiet  https://github.com/tevora-threat/SharpView/raw/master/Compiled/SharpView.exe
    # powerup https://github.com/PowerShellMafia/PowerSploit/tree/dev/Privesc
    # powersploit https://github.com/PowerShellMafia/PowerSploit/tree/dev
    # sharpup https://github.com/GhostPack/SharpUp
    wget --quiet https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/raw/master/SharpUp.exe
    # Rubeus https://github.com/GhostPack/Rubeus
    wget --quiet https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/raw/master/Rubeus.exe 
    # Inveigh https://github.com/Kevin-Robertson/Inveigh
    __get_github_release Kevin-Robertson/Inveigh "win"
    # responder
    # kerbrute
    __get_github_release ropnop/kerbrute "windows"
    # RogueWinRM
    __get_github_release antonioCoco/RogueWinRM "zip"
    # Snaffler
    __get_github_release SnaffCon/Snaffler "exe"
    # socat
    wget --quiet http://blog.gentilkiwi.com/downloads/socat-1.7.2.1.zip
    # 
    wget --quier https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/raw/master/Seatbelt.exe
}


function weaponize_linux(){
    __get_github_release jpillora/chisel 'linux_(386|amd64)'
    __get_github_release carlospolop/PEASS-ng "sh|386|amd64"
    __get_github_release DominicBreuker/pspy "s$"
}


function __set_active_symlink(){
    link=$1
    target=$2
    if [[ -L "$link" ]]; then
        rm -f $link
    else
        mv  $link "$link-save"
    fi
    ln -s $target $link
}




function __unset_active_symlink(){
    link=$1
    target=$2
    c_target=$(readlink -f $link)
#    echo "link $link"
#    echo "c_target $c_target"
#    echo $target
    if [[ "$c_target" == "$target" ]] ; then
        rm -f $link
        mv  "$link-save" $link
    fi
}
function pentest-activate(){
    if [[ $# -lt 1 ]] ; then
        echo 'invalid call: $0 name [path]'
        return
    fi

    PROJECT_BASE=${2:-$HOME/documents/pentesting-games/htb}
    PROJECT_NAME=$1
    PROJECT="$PROJECT_BASE/$PROJECT_NAME"

    JOHN_LOGS="$PROJECT/evidence/logging/john"
    CME_LOGS="$PROJECT/evidence/logging/cme"
    JWT_TOOL_LOGS="$PROJECT/evidence/logging/jwt_tool"
    HASHCAT_LOGS="$PROJECT/evidence/logging/hashcat"
    SQLMAP_LOGS="$PROJECT/evidence/logging/hashcat"
    TPLMAP_LOGS="$PROJECT/evidence/logging/tplmap"
    if [ -d "$PROJECT" ] ; then
        __set_active_symlink ~/.john $JOHN_LOGS
        __set_active_symlink  ~/.local/share/hashcat $HASHCAT_LOGS
        __set_active_symlink  ~/.cme $CME_LOGS
        __set_active_symlink  ~/.local/share/sqlmap $SQLMAP_LOGS
        __set_active_symlink  ~/.jwt_tool $JWT_TOOL_LOGS
        __set_active_symlink  ~/.tplmap $TPLMAP_LOGS
    fi
}

function pentest-init(){
    if [[ $# -lt 1 ]] ; then
        echo 'invalid call: $0 name [path]'
        return
    fi

    PROJECT_BASE=${2:-$HOME/documents/pentesting-games/htb}
    PROJECT_NAME=$1
    PROJECT="$PROJECT_BASE/$PROJECT_NAME"

    JOHN_LOGS="$PROJECT/evidence/logging/john"
    CME_LOGS="$PROJECT/evidence/logging/cme"
    JWT_TOOL_LOGS="$PROJECT/evidence/logging/jwt_tool"
    HASHCAT_LOGS="$PROJECT/evidence/logging/hashcat"
    SQLMAP_LOGS="$PROJECT/evidence/logging/hashcat"
    TPLMAP_LOGS="$PROJECT/evidence/logging/tplmap"
    if [ ! -d "$PROJECT" ] ; then
        mkdir -p $PROJECT/{admin,deliverables,evidence/{findings,scans/{vuln,service,web,ad},notes,osint,wireless,logging,misc},retest,utils}
        cp ~/documents/pentesting-write-up/box-template.tex $PROJECT/deliverables/$PROJECT_NAME.tex

        ln -s /usr/share/wordlists $PROJECT/utils/wordlists
        mkdir -p $JOHN_LOGS
        mkdir -p $HASHCAT_LOGS
        mkdir -p $CME_LOGS
        mkdir -p $SQLMAP_LOGS
        mkdir -p $JWT_TOOL_LOGS
        mkdir -p $TPLMAP_LOGS
    fi
    pentest-activate  $PROJECT_NAME $PROJECT_BASE 
}

function pentest-close(){
    if [[ $# -lt 1 ]] ; then
        echo 'invalid call: $0 name [path]'
        return
    fi

    PROJECT_BASE=${2:-$HOME/documents/pentesting-games/htb}
    PROJECT_NAME=$1
    PROJECT="$PROJECT_BASE/$PROJECT_NAME"

    JOHN_LOGS="$PROJECT/evidence/logging/john"
    CME_LOGS="$PROJECT/evidence/logging/cme"
    JWT_TOOL_LOGS="$PROJECT/evidence/logging/jwt_tool"
    HASHCAT_LOGS="$PROJECT/evidence/logging/hashcat"
    SQLMAP_LOGS="$PROJECT/evidence/logging/hashcat"
    TPLMAP_LOGS="$PROJECT/evidence/logging/tplmap"
    if [ -d "$PROJECT" ]; then
        __unset_active_symlink ~/.john $JOHN_LOGS
        __unset_active_symlink  ~/.local/share/hashcat $HASHCAT_LOGS
        __unset_active_symlink  ~/.cme $CME_LOGS
        __unset_active_symlink  ~/.local/share/sqlmap $SQLMAP_LOGS
        __unset_active_symlink  ~/.jwt_tool $JWT_TOOL_LOGS
        __unset_active_symlink  ~/.tplmap $TPLMAP_LOGS
        rm -f $PROJECT/utils/wordlists
        rm -rf $PROJECT
    fi
}





